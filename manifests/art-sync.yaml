apiVersion: batch/v1
kind: Job
metadata:
  name: art-to-vault
  namespace: default
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      containers:
      - name: vault-sync
        image: curlimages/curl:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -e
          echo "=== Syncing art to Vault ==="
          
          VAULT_TOKEN=$(cat /vault-token/token)
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Å–µ–∫—Ä–µ—Ç
          EXISTING=$(curl -k -s -H "X-Vault-Token: $VAULT_TOKEN" \
            https://vault.vault.svc:8200/v1/secret/data/art 2>/dev/null || echo "{}")
          
          # –°–æ–∑–¥–∞–µ–º —Ö—ç—à —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
          echo '{"data": {"art": "my-name"}}' > /tmp/new-data.json
          NEW_HASH=$(md5sum /tmp/new-data.json | cut -d' ' -f1)
          
          # –ï—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ö—ç—à
          if echo "$EXISTING" | grep -q '"data"'; then
            EXISTING_HASH=$(echo "$EXISTING" | md5sum | cut -d' ' -f1)
            if [ "$NEW_HASH" = "$EXISTING_HASH" ]; then
              echo "‚úÖ Secret already up-to-date in Vault, skipping..."
              exit 0
            fi
            echo "‚ö†Ô∏è  Secret exists but differs, updating..."
          else
            echo "üìù Creating new secret in Vault..."
          fi
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Vault
          curl -k -X POST \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            -H "Content-Type: application/json" \
            -d @/tmp/new-data.json \
            https://vault.vault.svc:8200/v1/secret/data/art
          
          echo "‚úÖ Done"
          sleep 3
        volumeMounts:
        - name: secrets
          mountPath: /secrets
          readOnly: true
        - name: vault-token
          mountPath: /vault-token
          readOnly: true
      volumes:
      - name: secrets
        secret:
          secretName: art
      - name: vault-token
        secret:
          secretName: vault-token
      restartPolicy: Never
