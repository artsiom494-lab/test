apiVersion: batch/v1
kind: Job
metadata:
  name: app-database2-to-vault
  namespace: default
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      containers:
      - name: vault-sync
        image: alpine/curl:latest
        env:
        - name: VAULT_ADDR
          value: "https://vault.vault.svc:8200"
        - name: VAULT_SKIP_VERIFY
          value: "true"
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -ex
          echo "=== Syncing app-database2 to Vault ==="
          
          # 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð°
          echo "1. Checking Vault token..."
          if [ ! -f /vault-token/token ]; then
            echo "âŒ Vault token not found at /vault-token/token"
            ls -la /vault-token/
            exit 1
          fi
          
          VAULT_TOKEN=$(cat /vault-token/token)
          echo "Token exists (first 10 chars): ${VAULT_TOKEN:0:10}..."
          
          # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Vault
          echo "2. Checking Vault connectivity..."
          curl -k -s -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/sys/health" || {
            echo "âŒ Cannot connect to Vault"
            exit 1
          }
          
          # 3. Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· ÑÐ¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑÐµÐºÑ€ÐµÑ‚Ð°
          echo "3. Reading data from mounted secret..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ JSON Ð¸Ð· Ð²ÑÐµÑ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          echo '{"data": {' > /tmp/new-data.json
          FIRST=true
          for FILE in /tmp/k8s-secret/*; do
            KEY=$(basename "$FILE")
            VALUE=$(cat "$FILE")
            
            if [ "$FIRST" = false ]; then
              echo -n ', ' >> /tmp/new-data.json
            fi
            # Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼ JSON
            ESCAPED_VALUE=$(echo "$VALUE" | sed 's/"/\\"/g')
            echo -n "\"$KEY\": \"$ESCAPED_VALUE\"" >> /tmp/new-data.json
            FIRST=false
            
            echo "  Found key: $KEY (value length: ${#VALUE})"
          done
          echo '}}' >> /tmp/new-data.json
          
          echo "Generated JSON:"
          cat /tmp/new-data.json
          
          # 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÑÐµÐºÑ€ÐµÑ‚ Ð² Vault
          echo "4. Checking existing secret in Vault..."
          EXISTING_RESPONSE=$(curl -k -s -w "\n%{http_code}" \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/secret/data/apps/database2" 2>/dev/null || echo "{\"errors\":[]}")
          
          HTTP_CODE=$(echo "$EXISTING_RESPONSE" | tail -n1)
          EXISTING_BODY=$(echo "$EXISTING_RESPONSE" | head -n-1)
          
          echo "Vault response code: $HTTP_CODE"
          
          # 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ…ÑÑˆ
          NEW_HASH=$(md5sum /tmp/new-data.json | cut -d' ' -f1)
          echo "New data hash: $NEW_HASH"
          
          if [ "$HTTP_CODE" = "200" ] && echo "$EXISTING_BODY" | grep -q '"data"'; then
            echo "Existing secret found, comparing..."
            echo "$EXISTING_BODY" | jq '.data' > /tmp/existing-data.json 2>/dev/null || \
              echo "$EXISTING_BODY" > /tmp/existing-data.json
            
            EXISTING_HASH=$(md5sum /tmp/existing-data.json | cut -d' ' -f1)
            echo "Existing hash: $EXISTING_HASH"
            
            if [ "$NEW_HASH" = "$EXISTING_HASH" ]; then
              echo "âœ… Secret already up-to-date in Vault, skipping..."
              exit 0
            fi
            echo "âš ï¸  Secret exists but differs, updating..."
          else
            echo "ðŸ“ Creating new secret in Vault (HTTP code: $HTTP_CODE)..."
          fi
          
          # 6. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² Vault
          echo "6. Sending to Vault..."
          RESPONSE=$(curl -k -s -w "\n%{http_code}" -X POST \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            -H "Content-Type: application/json" \
            -d @/tmp/new-data.json \
            "$VAULT_ADDR/v1/secret/data/apps/database2" 2>/dev/null)
          
          RESPONSE_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "Response code: $RESPONSE_CODE"
          echo "Response body: $RESPONSE_BODY"
          
          if [ "$RESPONSE_CODE" = "200" ] || [ "$RESPONSE_CODE" = "204" ]; then
            echo "âœ… Successfully synced to Vault"
          else
            echo "âŒ Failed to sync to Vault. HTTP: $RESPONSE_CODE"
            exit 1
          fi
          
          # 7. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼
          echo "7. Verifying..."
          curl -k -s -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/secret/data/apps/database2" | jq .data 2>/dev/null || \
            curl -k -s -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/secret/data/apps/database2"
        volumeMounts:
        - name: secrets
          mountPath: /tmp/k8s-secret
          readOnly: true
        - name: vault-token
          mountPath: /vault-token
          readOnly: true
      volumes:
      - name: secrets
        secret:
          secretName: app-database2
      - name: vault-token
        secret:
          secretName: vault-token
      restartPolicy: Never
